/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  it.unimi.dsi.fastutil.ints.IntListIterator
 *  net.minecraft.entity.projectile.FireworkRocketEntity
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.c2s.common.CommonPongC2SPacket
 *  net.minecraft.network.packet.s2c.play.EntitiesDestroyS2CPacket
 *  net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket
 */
package dev.gzsakura_miitong.mod.modules.impl.exploit;

import dev.gzsakura_miitong.api.events.eventbus.EventListener;
import dev.gzsakura_miitong.api.events.impl.ClientTickEvent;
import dev.gzsakura_miitong.api.events.impl.PacketEvent;
import dev.gzsakura_miitong.api.events.impl.RemoveFireworkEvent;
import dev.gzsakura_miitong.api.utils.math.Timer;
import dev.gzsakura_miitong.asm.accessors.IFireworkRocketEntity;
import dev.gzsakura_miitong.mod.modules.Module;
import dev.gzsakura_miitong.mod.modules.settings.impl.SliderSetting;
import it.unimi.dsi.fastutil.ints.IntListIterator;
import java.util.ArrayList;
import java.util.List;
import net.minecraft.entity.projectile.FireworkRocketEntity;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.common.CommonPongC2SPacket;
import net.minecraft.network.packet.s2c.play.EntitiesDestroyS2CPacket;
import net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket;

public class RocketExtend
extends Module {
    final List<CommonPongC2SPacket> packetList = new ArrayList<CommonPongC2SPacket>();
    private final Timer extendFireworkTimer = new Timer();
    private final SliderSetting time = this.add(new SliderSetting("Time", 10.0, 0.0, 50.0, 0.1));
    private boolean extendFirework;
    private FireworkRocketEntity firework;

    public RocketExtend() {
        super("RocketExtend", Module.Category.Exploit);
        this.setChinese("\u70df\u82b1\u5ef6\u957f");
    }

    @Override
    public void onDisable() {
        if (this.firework != null) {
            ((IFireworkRocketEntity)this.firework).hookExplodeAndRemove();
        }
        this.firework = null;
        this.extendFirework = false;
        for (CommonPongC2SPacket packet : this.packetList) {
            mc.getNetworkHandler().sendPacket((Packet)packet);
        }
        this.packetList.clear();
    }

    @EventListener
    public void onRemoveFirework(RemoveFireworkEvent event) {
        if (RocketExtend.mc.player == null) {
            return;
        }
        if (RocketExtend.mc.player.isFallFlying() && this.firework != event.getRocketEntity() && ((IFireworkRocketEntity)event.getRocketEntity()).hookWasShotByEntity() && ((IFireworkRocketEntity)event.getRocketEntity()).getShooter() == RocketExtend.mc.player) {
            this.extendFirework = true;
            event.cancel();
            this.firework = event.getRocketEntity();
            this.extendFireworkTimer.reset();
        }
    }

    @EventListener
    public void onTick(ClientTickEvent event) {
        if (RocketExtend.nullCheck()) {
            return;
        }
        if (!this.extendFirework) {
            return;
        }
        if (!RocketExtend.mc.player.isFallFlying() || RocketExtend.mc.player.isOnGround() || this.extendFireworkTimer.passedS(this.time.getValue())) {
            this.extendFirework = false;
            if (this.firework != null) {
                ((IFireworkRocketEntity)this.firework).hookExplodeAndRemove();
                this.firework = null;
            }
            for (CommonPongC2SPacket packet : this.packetList) {
                mc.getNetworkHandler().sendPacket((Packet)packet);
            }
            this.packetList.clear();
        }
    }

    @EventListener
    public void onPacketOutbound(PacketEvent.Send event) {
        if (RocketExtend.mc.player == null || RocketExtend.mc.world == null) {
            return;
        }
        Packet<?> packet = event.getPacket();
        if (packet instanceof CommonPongC2SPacket) {
            CommonPongC2SPacket packet2 = (CommonPongC2SPacket)packet;
            if (this.extendFirework && RocketExtend.mc.player.isFallFlying()) {
                event.cancel();
                this.packetList.add(packet2);
            }
        }
    }

    @EventListener
    public void onPacketInbound(PacketEvent.Receive event) {
        if (RocketExtend.nullCheck() || !RocketExtend.mc.player.isFallFlying() || !this.extendFirework) {
            return;
        }
        Packet<?> packet = event.getPacket();
        if (packet instanceof EntitiesDestroyS2CPacket) {
            EntitiesDestroyS2CPacket destroyPacket = (EntitiesDestroyS2CPacket)packet;
            if (this.firework != null) {
                IntListIterator intListIterator = destroyPacket.getEntityIds().iterator();
                while (intListIterator.hasNext()) {
                    int id = (Integer)intListIterator.next();
                    if (id != this.firework.getId()) continue;
                    event.cancel();
                    return;
                }
            }
        }
        if (event.getPacket() instanceof PlayerPositionLookS2CPacket) {
            this.extendFirework = false;
            if (this.firework != null) {
                ((IFireworkRocketEntity)this.firework).hookExplodeAndRemove();
                this.firework = null;
            }
            for (CommonPongC2SPacket p : this.packetList) {
                mc.getNetworkHandler().sendPacket((Packet)p);
            }
            this.packetList.clear();
        }
    }
}

