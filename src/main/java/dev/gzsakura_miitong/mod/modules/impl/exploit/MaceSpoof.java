/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  io.netty.buffer.Unpooled
 *  net.minecraft.entity.Entity
 *  net.minecraft.entity.decoration.EndCrystalEntity
 *  net.minecraft.item.Items
 *  net.minecraft.network.PacketByteBuf
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket$InteractType
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$PositionAndOnGround
 */
package dev.gzsakura_miitong.mod.modules.impl.exploit;

import dev.gzsakura_miitong.api.events.eventbus.EventListener;
import dev.gzsakura_miitong.api.events.impl.PacketEvent;
import dev.gzsakura_miitong.api.utils.player.EntityUtil;
import dev.gzsakura_miitong.api.utils.player.InventoryUtil;
import dev.gzsakura_miitong.asm.accessors.IPlayerMoveC2SPacket;
import dev.gzsakura_miitong.mod.modules.Module;
import dev.gzsakura_miitong.mod.modules.impl.combat.Criticals;
import dev.gzsakura_miitong.mod.modules.settings.impl.BooleanSetting;
import dev.gzsakura_miitong.mod.modules.settings.impl.EnumSetting;
import dev.gzsakura_miitong.mod.modules.settings.impl.SliderSetting;
import io.netty.buffer.Unpooled;
import net.minecraft.entity.Entity;
import net.minecraft.entity.decoration.EndCrystalEntity;
import net.minecraft.item.Items;
import net.minecraft.network.PacketByteBuf;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;

public class MaceSpoof
extends Module {
    public static MaceSpoof INSTANCE;
    private final EnumSetting<Mode> mode = this.add(new EnumSetting<Mode>("Mode", Mode.Vanilla));
    private final BooleanSetting noCrystal = this.add(new BooleanSetting("NoCrystal", true, () -> this.mode.is(Mode.Swap)));
    private final BooleanSetting inventorySwap = this.add(new BooleanSetting("InventorySwap", false, () -> this.mode.is(Mode.Swap)));
    private final BooleanSetting onlyGround = this.add(new BooleanSetting("OnlyGround", true, () -> this.mode.is(Mode.Vanilla)));
    private final SliderSetting height = this.add(new SliderSetting("Height", 25.0, 0.0, 2000.0, 0.1, () -> this.mode.is(Mode.Vanilla)));
    boolean ignore = false;
    private PlayerInteractEntityC2SPacket lastPacket = null;

    public MaceSpoof() {
        super("MaceSpoof", Module.Category.Exploit);
        this.setChinese("\u98ce\u9524\u52a0\u4f24");
        INSTANCE = this;
    }

    public static Entity getEntity(PlayerInteractEntityC2SPacket packet) {
        PacketByteBuf packetBuf = new PacketByteBuf(Unpooled.buffer());
        packet.write(packetBuf);
        return MaceSpoof.mc.world == null ? null : MaceSpoof.mc.world.getEntityById(packetBuf.readVarInt());
    }

    public static InteractType getInteractType(PlayerInteractEntityC2SPacket packet) {
        PacketByteBuf packetBuf = new PacketByteBuf(Unpooled.buffer());
        packet.write(packetBuf);
        packetBuf.readVarInt();
        return (InteractType)packetBuf.readEnumConstant(InteractType.class);
    }

    @EventListener(priority=200)
    public void onPacketSend(PacketEvent.Send event) {
        if (MaceSpoof.nullCheck()) {
            return;
        }
        if (this.mode.is(Mode.Vanilla)) {
            Entity entity;
            PlayerInteractEntityC2SPacket packet;
            Packet<?> packet2;
            if (!(MaceSpoof.mc.player.getMainHandStack().getItem() != Items.MACE || !((packet2 = event.getPacket()) instanceof PlayerInteractEntityC2SPacket) || MaceSpoof.getInteractType(packet = (PlayerInteractEntityC2SPacket)packet2) != InteractType.ATTACK || (entity = MaceSpoof.getEntity(packet)) instanceof EndCrystalEntity || this.onlyGround.getValue() && !MaceSpoof.mc.player.isOnGround() && !MaceSpoof.mc.player.getAbilities().flying || MaceSpoof.mc.player.isInLava() || MaceSpoof.mc.player.isSubmergedInWater() || entity == null)) {
                for (int i = 0; i < 4; ++i) {
                    this.sendFakeY(0.0);
                }
                this.sendFakeY(this.height.getValue());
                this.sendFakeY(0.0);
            }
        } else if (this.mode.is(Mode.NCP)) {
            if (event.getPacket() instanceof PlayerMoveC2SPacket) {
                ((IPlayerMoveC2SPacket)event.getPacket()).setOnGround(false);
            }
        } else if (this.mode.is(Mode.Swap)) {
            PlayerInteractEntityC2SPacket packet;
            if (event.isCancelled()) {
                return;
            }
            int slot = this.getMaceSlot();
            if (slot == -1) {
                return;
            }
            if (this.ignore) {
                return;
            }
            Packet<?> packet3 = event.getPacket();
            if (packet3 instanceof PlayerInteractEntityC2SPacket && Criticals.getInteractType(packet = (PlayerInteractEntityC2SPacket)packet3) == PlayerInteractEntityC2SPacket.InteractType.ATTACK) {
                if (this.noCrystal.getValue() && Criticals.getEntity(packet) instanceof EndCrystalEntity) {
                    return;
                }
                this.lastPacket = packet;
                this.ignore = true;
                this.doSpoof();
                this.ignore = false;
                event.cancel();
            }
        }
    }

    private void doSpoof() {
        if (this.lastPacket == null) {
            return;
        }
        int slot = this.getMaceSlot();
        if (slot == -1) {
            return;
        }
        int old = MaceSpoof.mc.player.getInventory().selectedSlot;
        this.doSwap(slot);
        mc.getNetworkHandler().sendPacket((Packet)this.lastPacket);
        if (this.inventorySwap.getValue()) {
            this.doSwap(slot);
            EntityUtil.syncInventory();
        } else {
            this.doSwap(old);
        }
    }

    private void doSwap(int slot) {
        if (this.inventorySwap.getValue()) {
            InventoryUtil.inventorySwap(slot, MaceSpoof.mc.player.getInventory().selectedSlot);
        } else {
            InventoryUtil.switchToSlot(slot);
        }
    }

    private int getMaceSlot() {
        if (this.inventorySwap.getValue()) {
            return InventoryUtil.findItemInventorySlot(Items.MACE);
        }
        return InventoryUtil.findItem(Items.MACE);
    }

    private void sendFakeY(double offset) {
        mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(MaceSpoof.mc.player.getX(), MaceSpoof.mc.player.getY() + offset, MaceSpoof.mc.player.getZ(), false));
    }

    public static enum Mode {
        Vanilla,
        NCP,
        Swap;

    }

    public static enum InteractType {
        INTERACT,
        ATTACK,
        INTERACT_AT;

    }
}

