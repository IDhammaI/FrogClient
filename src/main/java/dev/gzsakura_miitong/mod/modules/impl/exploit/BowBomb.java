/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  net.minecraft.client.network.AbstractClientPlayerEntity
 *  net.minecraft.entity.Entity
 *  net.minecraft.entity.player.PlayerEntity
 *  net.minecraft.item.Items
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket
 *  net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket$Mode
 *  net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket$Action
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$Full
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$PositionAndOnGround
 *  net.minecraft.util.math.Vec3d
 */
package dev.gzsakura_miitong.mod.modules.impl.exploit;

import dev.gzsakura_miitong.Alien;
import dev.gzsakura_miitong.api.events.eventbus.EventListener;
import dev.gzsakura_miitong.api.events.impl.PacketEvent;
import dev.gzsakura_miitong.api.events.impl.UpdateEvent;
import dev.gzsakura_miitong.api.events.impl.UpdateRotateEvent;
import dev.gzsakura_miitong.api.utils.combat.CombatUtil;
import dev.gzsakura_miitong.api.utils.math.PredictUtil;
import dev.gzsakura_miitong.api.utils.math.Timer;
import dev.gzsakura_miitong.core.impl.RotationManager;
import dev.gzsakura_miitong.mod.modules.Module;
import dev.gzsakura_miitong.mod.modules.settings.impl.BooleanSetting;
import dev.gzsakura_miitong.mod.modules.settings.impl.EnumSetting;
import dev.gzsakura_miitong.mod.modules.settings.impl.SliderSetting;
import java.util.Random;
import net.minecraft.client.network.AbstractClientPlayerEntity;
import net.minecraft.entity.Entity;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.item.Items;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.util.math.Vec3d;

public class BowBomb
extends Module {
    public static boolean send = false;
    private final EnumSetting<exploitEn> exploit = this.add(new EnumSetting<exploitEn>("Exploit", exploitEn.Strong));
    private final Random random = new Random();
    private final Timer delayTimer = new Timer();
    private final BooleanSetting aim = this.add(new BooleanSetting("Aimbot", true));
    private final SliderSetting predictTicks = this.add(new SliderSetting("PredictTicks", 3.0, 0.0, 10.0, 0.1));
    private final BooleanSetting rotation = this.add(new BooleanSetting("Rotation", false));
    private final SliderSetting spoofs = this.add(new SliderSetting("Spoofs", 50.0, 0.0, 200.0, 1.0));
    private final BooleanSetting minimize = this.add(new BooleanSetting("Minimize", false));
    private final SliderSetting delay = this.add(new SliderSetting("Delay", 5.0, 0.0, 10.0).setSuffix("s"));
    private final SliderSetting activeTime = this.add(new SliderSetting("ActiveTime", (double)0.4f, 0.0, 3.0, 0.01).setSuffix("s"));
    private final BooleanSetting message = this.add(new BooleanSetting("Message", true));
    private final Timer activeTimer = new Timer();
    boolean active = false;

    public BowBomb() {
        super("BowBomb", "exploit", Module.Category.Exploit);
        this.setChinese("\u5f13\u6f0f\u6d1e");
    }

    @EventListener
    public void onMotion(UpdateRotateEvent event) {
        if (!BowBomb.mc.player.isUsingItem() || BowBomb.mc.player.getActiveItem().getItem() != Items.BOW || !this.aim.getValue()) {
            return;
        }
        PlayerEntity target = this.getTarget();
        if (target == null) {
            return;
        }
        Vec3d headPos = PredictUtil.getPos(target, this.predictTicks.getValueInt()).add(0.0, (double)target.getEyeHeight(target.getPose()), 0.0);
        float[] rotations = RotationManager.getRotation(headPos);
        event.setRotation(rotations[0], rotations[1]);
    }

    private PlayerEntity getTarget() {
        AbstractClientPlayerEntity target = null;
        double getDistance = 100000.0;
        for (AbstractClientPlayerEntity player : Alien.THREAD.getPlayers()) {
            if (Math.abs(player.getY() - BowBomb.mc.player.getY()) > 4.0 || !CombatUtil.isValid((Entity)player, getDistance)) continue;
            target = player;
            getDistance = BowBomb.mc.player.distanceTo((Entity)player);
        }
        return target;
    }

    @EventListener
    public void onUpdate(UpdateEvent event) {
        if (!BowBomb.mc.player.isUsingItem() || BowBomb.mc.player.getActiveItem().getItem() != Items.BOW) {
            this.activeTimer.reset();
            this.active = false;
        } else {
            this.active = true;
        }
    }

    @Override
    public void onDisable() {
        send = false;
    }

    @EventListener
    protected void onPacketSend(PacketEvent.Send event) {
        PlayerActionC2SPacket packet;
        if (BowBomb.nullCheck() || !this.delayTimer.passed((long)(this.delay.getValue() * 1000.0)) || !this.activeTimer.passed((long)(this.activeTime.getValue() * 1000.0)) || !this.active) {
            return;
        }
        Packet<?> packet2 = event.getPacket();
        if (packet2 instanceof PlayerActionC2SPacket && (packet = (PlayerActionC2SPacket)packet2).getAction() == PlayerActionC2SPacket.Action.RELEASE_USE_ITEM) {
            send = true;
            if (this.message.getValue()) {
                this.sendMessage("\u00a7eBowBomb trigger.");
            }
            mc.getNetworkHandler().sendPacket((Packet)new ClientCommandC2SPacket((Entity)BowBomb.mc.player, ClientCommandC2SPacket.Mode.START_SPRINTING));
            if (this.exploit.getValue() == exploitEn.Fast) {
                for (int i = 0; i < this.getRuns(); ++i) {
                    this.spoof(BowBomb.mc.player.getX(), this.minimize.getValue() ? BowBomb.mc.player.getY() : BowBomb.mc.player.getY() - 1.0E-10, BowBomb.mc.player.getZ(), true);
                    this.spoof(BowBomb.mc.player.getX(), BowBomb.mc.player.getY() + 1.0E-10, BowBomb.mc.player.getZ(), false);
                }
            }
            if (this.exploit.getValue() == exploitEn.Strong) {
                for (int i = 0; i < this.getRuns(); ++i) {
                    this.spoof(BowBomb.mc.player.getX(), BowBomb.mc.player.getY() + 1.0E-10, BowBomb.mc.player.getZ(), false);
                    this.spoof(BowBomb.mc.player.getX(), this.minimize.getValue() ? BowBomb.mc.player.getY() : BowBomb.mc.player.getY() - 1.0E-10, BowBomb.mc.player.getZ(), true);
                }
            }
            if (this.exploit.getValue() == exploitEn.Phobos) {
                for (int i = 0; i < this.getRuns(); ++i) {
                    this.spoof(BowBomb.mc.player.getX(), BowBomb.mc.player.getY() + 1.3E-13, BowBomb.mc.player.getZ(), true);
                    this.spoof(BowBomb.mc.player.getX(), BowBomb.mc.player.getY() + 2.7E-13, BowBomb.mc.player.getZ(), false);
                }
            }
            if (this.exploit.getValue() == exploitEn.Strict) {
                double[] strict_direction = new double[]{100.0 * -Math.sin(Math.toRadians(BowBomb.mc.player.getYaw())), 100.0 * Math.cos(Math.toRadians(BowBomb.mc.player.getYaw()))};
                for (int i = 0; i < this.getRuns(); ++i) {
                    if (this.random.nextBoolean()) {
                        this.spoof(BowBomb.mc.player.getX() - strict_direction[0], BowBomb.mc.player.getY(), BowBomb.mc.player.getZ() - strict_direction[1], false);
                        continue;
                    }
                    this.spoof(BowBomb.mc.player.getX() + strict_direction[0], BowBomb.mc.player.getY(), BowBomb.mc.player.getZ() + strict_direction[1], true);
                }
            }
            send = false;
            this.delayTimer.reset();
        }
    }

    private void spoof(double x, double y, double z, boolean ground) {
        if (this.rotation.getValue()) {
            mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.Full(x, y, z, BowBomb.mc.player.getYaw(), BowBomb.mc.player.getPitch(), ground));
        } else {
            mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(x, y, z, ground));
        }
    }

    private int getRuns() {
        return this.spoofs.getValueInt();
    }

    private static enum exploitEn {
        Strong,
        Fast,
        Strict,
        Phobos;

    }
}

