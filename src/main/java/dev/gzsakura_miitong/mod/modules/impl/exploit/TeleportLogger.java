/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  com.google.common.collect.Maps
 *  net.minecraft.client.network.AbstractClientPlayerEntity
 *  net.minecraft.client.util.math.MatrixStack
 *  net.minecraft.entity.player.PlayerEntity
 *  net.minecraft.sound.SoundEvents
 *  net.minecraft.util.math.Box
 *  net.minecraft.util.math.Vec3d
 */
package dev.gzsakura_miitong.mod.modules.impl.exploit;

import com.google.common.collect.Maps;
import dev.gzsakura_miitong.Alien;
import dev.gzsakura_miitong.api.events.eventbus.EventListener;
import dev.gzsakura_miitong.api.events.impl.DeathEvent;
import dev.gzsakura_miitong.api.events.impl.PlaySoundEvent;
import dev.gzsakura_miitong.api.events.impl.UpdateEvent;
import dev.gzsakura_miitong.api.utils.entity.CopyPlayerEntity;
import dev.gzsakura_miitong.api.utils.math.Timer;
import dev.gzsakura_miitong.api.utils.render.ModelPlayer;
import dev.gzsakura_miitong.api.utils.render.Render3DUtil;
import dev.gzsakura_miitong.api.utils.world.BlockUtil;
import dev.gzsakura_miitong.asm.accessors.IEntity;
import dev.gzsakura_miitong.mod.modules.Module;
import dev.gzsakura_miitong.mod.modules.settings.impl.BooleanSetting;
import dev.gzsakura_miitong.mod.modules.settings.impl.ColorSetting;
import dev.gzsakura_miitong.mod.modules.settings.impl.SliderSetting;
import java.awt.Color;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.CopyOnWriteArrayList;
import net.minecraft.client.network.AbstractClientPlayerEntity;
import net.minecraft.client.util.math.MatrixStack;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.sound.SoundEvents;
import net.minecraft.util.math.Box;
import net.minecraft.util.math.Vec3d;

public class TeleportLogger
extends Module {
    public static TeleportLogger INSTANCE;
    private final BooleanSetting message = this.add(new BooleanSetting("Message", true));
    private final ColorSetting box = this.add(new ColorSetting("Box", new Color(255, 255, 255, 100)).injectBoolean(true));
    private final ColorSetting fill = this.add(new ColorSetting("Fill", new Color(255, 255, 255, 100)).injectBoolean(true));
    private final ColorSetting text = this.add(new ColorSetting("Text", new Color(255, 255, 255, 255)).injectBoolean(true));
    private final ColorSetting chamsFill = this.add(new ColorSetting("ChamsFill", new Color(255, 255, 255, 100)).injectBoolean(true));
    private final ColorSetting chamsLine = this.add(new ColorSetting("ChamsLine", new Color(255, 255, 255, 100)).injectBoolean(true));
    private final BooleanSetting chorus = this.add(new BooleanSetting("Chorus", false).setParent());
    private final SliderSetting maxTime = this.add(new SliderSetting("MaxTime", 10.0, 0.0, 50.0, 1.0, this.chorus::isOpen).setSuffix("s"));
    private final BooleanSetting teleport = this.add(new BooleanSetting("Teleport", false).setParent());
    private final SliderSetting delay = this.add(new SliderSetting("Delay", 1.0, 0.0, 10.0, 0.01, this.teleport::isOpen).setSuffix("s"));
    private final SliderSetting getDistance = this.add(new SliderSetting("Distance", 20.0, 0.0, 100.0, 0.01, this.teleport::isOpen).setSuffix("m"));
    private final Map<UUID, CopyPlayerEntity> playerCaches = Maps.newConcurrentMap();
    private final Map<UUID, ModelPlayer> blinkCaches = Maps.newConcurrentMap();
    private static final CopyOnWriteArrayList<Pair> pair;
    private final Timer timer = new Timer();

    public TeleportLogger() {
        super("TeleportLogger", Module.Category.Exploit);
        this.setChinese("\u4f20\u9001\u68c0\u6d4b");
        INSTANCE = this;
    }

    @Override
    public void onEnable() {
        this.playerCaches.clear();
        this.blinkCaches.clear();
    }

    @Override
    public void onLogin() {
        this.playerCaches.clear();
        this.blinkCaches.clear();
    }

    @EventListener
    public void onDeath(DeathEvent event) {
        if (this.teleport.getValue()) {
            this.playerCaches.remove(event.getPlayer().getGameProfile().getId());
            this.blinkCaches.remove(event.getPlayer().getGameProfile().getId());
        }
    }

    @EventListener
    public void onUpdate(UpdateEvent event) {
        if (this.chorus.getValue()) {
            pair.removeIf(Pair::remove);
        }
        if (this.teleport.getValue() && this.timer.passedS(this.delay.getValue())) {
            this.timer.reset();
            for (AbstractClientPlayerEntity player : Alien.THREAD.getPlayers()) {
                if (player == null || player.equals((Object)TeleportLogger.mc.player)) continue;
                CopyPlayerEntity playerCache = this.playerCaches.get(player.getGameProfile().getId());
                if (playerCache != null && BlockUtil.distanceToXZ(playerCache.getX(), playerCache.getZ(), player.getX(), player.getZ()) >= this.getDistance.getValue()) {
                    if (this.message.getValue()) {
                        this.sendMessage("\u00a7f" + player.getName().getString() + " \u00a7rTeleported to \u00a7f" + player.getBlockX() + ", " + player.getBlockY() + ", " + player.getBlockZ() + ".");
                    }
                    this.blinkCaches.put(player.getGameProfile().getId(), new ModelPlayer(playerCache));
                }
                this.playerCaches.put(player.getGameProfile().getId(), new CopyPlayerEntity((PlayerEntity)player));
            }
        }
    }

    @Override
    public void onRender3D(MatrixStack matrixStack) {
        Box box;
        if (this.teleport.getValue()) {
            for (ModelPlayer data : this.blinkCaches.values()) {
                PlayerEntity player = data.player;
                box = ((IEntity)player).getDimensions().getBoxAt(player.getPos());
                if (this.box.booleanValue) {
                    Render3DUtil.drawBox(matrixStack, box, this.box.getValue());
                }
                if (this.fill.booleanValue) {
                    Render3DUtil.drawFill(matrixStack, box, this.fill.getValue());
                }
                if (this.chamsFill.booleanValue || this.chamsLine.booleanValue) {
                    data.render(matrixStack, this.chamsFill, this.chamsLine);
                }
                if (!this.text.booleanValue) continue;
                Render3DUtil.drawText3D(player.getName().getString() + " Teleported", new Vec3d(player.getX(), ((IEntity)player).getDimensions().getBoxAt((Vec3d)player.getPos()).maxY + 0.5, player.getZ()), this.text.getValue());
            }
        }
        if (this.chorus.getValue()) {
            for (Pair pair1 : pair) {
                Vec3d chorusPos = pair1.pos;
                box = new Box(chorusPos.getX() - 0.3, chorusPos.getY(), chorusPos.getZ() - 0.3, chorusPos.getX() + 0.3, chorusPos.getY() + 1.85, chorusPos.getZ() + 0.3);
                if (this.box.booleanValue) {
                    Render3DUtil.drawBox(matrixStack, box, this.box.getValue());
                }
                if (this.fill.booleanValue) {
                    Render3DUtil.drawFill(matrixStack, box, this.fill.getValue());
                }
                if (!this.text.booleanValue) continue;
                Render3DUtil.drawText3D("Chorus", new Vec3d(box.getCenter().getX(), box.maxY + 0.5, box.getCenter().getZ()), this.text.getValue());
            }
        }
    }

    @EventListener
    public void onPlaySound(PlaySoundEvent event) {
        if (TeleportLogger.nullCheck() || !this.chorus.getValue()) {
            return;
        }
        if (event.sound.getId() == SoundEvents.ITEM_CHORUS_FRUIT_TELEPORT.getId()) {
            pair.add(new Pair(new Vec3d(event.sound.getX(), event.sound.getY(), event.sound.getZ()), new Timer()));
        }
    }

    static {
        pair = new CopyOnWriteArrayList();
    }

    private record Pair(Vec3d pos, Timer timer) {
        public boolean remove() {
            return this.timer.passedS(TeleportLogger.INSTANCE.maxTime.getValue());
        }
    }
}

