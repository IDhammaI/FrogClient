/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$Full
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$PositionAndOnGround
 *  net.minecraft.util.math.MathHelper
 */
package dev.idhammai.mod.modules.impl.exploit;

import dev.idhammai.api.events.eventbus.EventListener;
import dev.idhammai.api.events.impl.PacketEvent;
import dev.idhammai.api.events.impl.SendMovementPacketsEvent;
import dev.idhammai.api.utils.math.MathUtil;
import dev.idhammai.api.utils.math.Timer;
import dev.idhammai.api.utils.player.MovementUtil;
import dev.idhammai.mod.modules.Module;
import dev.idhammai.mod.modules.settings.impl.BooleanSetting;
import dev.idhammai.mod.modules.settings.impl.SliderSetting;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.util.math.MathHelper;

public class PacketControl
extends Module {
    public static PacketControl INSTANCE;
    private final BooleanSetting timerBypass = this.add(new BooleanSetting("TimerBypass", true).setParent());
    private final SliderSetting fullPackets = this.add(new SliderSetting("FullPackets", 15, 1, 50, this.timerBypass::isOpen));
    private final SliderSetting positionPackets = this.add(new SliderSetting("PositionPackets", 15, 1, 50, this.timerBypass::isOpen));
    public final BooleanSetting positionSync = this.add(new BooleanSetting("PositionSync", true).setParent());
    public final SliderSetting positionDelay = this.add(new SliderSetting("Delay", 20, 0, 40, this.positionSync::isOpen).setSuffix("ticks"));
    private final Timer groundT = new Timer();
    private final Timer rotationT = new Timer();
    private final Timer positionT = new Timer();
    public boolean full = true;
    private int fullPacket;
    private int positionPacket;
    private float yaw;
    private float pitch;

    public PacketControl() {
        super("PacketControl", Module.Category.Exploit);
        this.setChinese("\u53d1\u5305\u63a7\u5236");
        INSTANCE = this;
    }

    @EventListener(priority=-999)
    public void onRotation(SendMovementPacketsEvent event) {
        if (!MovementUtil.isMoving() || !this.timerBypass.getValue()) {
            return;
        }
        if (this.full) {
            this.yaw = MathHelper.wrapDegrees((float)(event.getYaw() + MathUtil.random(-2.0f, 2.0f)));
            this.pitch = MathUtil.clamp(event.getPitch() + MathUtil.random(-2.0f, 2.0f), -90.0f, 90.0f);
        }
        event.setYaw(this.yaw);
        event.setPitch(this.pitch);
    }

    @EventListener
    public void onPacketSend(PacketEvent.Send event) {
        Packet<?> packet = event.getPacket();
        if (packet instanceof PlayerMoveC2SPacket) {
            PlayerMoveC2SPacket packet2 = (PlayerMoveC2SPacket)packet;
            if (packet2.changesPosition()) {
                this.positionT.reset();
            }
            if (packet2.changesLook()) {
                this.rotationT.reset();
            }
            this.groundT.reset();
            if (packet2 instanceof PlayerMoveC2SPacket.PositionAndOnGround && !this.full) {
                ++this.positionPacket;
                if ((double)this.positionPacket >= this.positionPackets.getValue()) {
                    this.positionPacket = 0;
                    this.full = true;
                }
            } else if (packet2 instanceof PlayerMoveC2SPacket.Full && this.full) {
                ++this.fullPacket;
                if ((double)this.fullPacket >= this.fullPackets.getValue()) {
                    this.fullPacket = 0;
                    this.full = false;
                }
            }
        }
    }
}

