/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  com.mojang.authlib.GameProfile
 *  net.minecraft.client.font.TextRenderer
 *  net.minecraft.client.gui.DrawContext
 *  net.minecraft.client.network.OtherClientPlayerEntity
 *  net.minecraft.entity.Entity
 *  net.minecraft.entity.Entity$RemovalReason
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.c2s.common.KeepAliveC2SPacket
 *  net.minecraft.network.packet.c2s.play.AdvancementTabC2SPacket
 *  net.minecraft.network.packet.c2s.play.ChatMessageC2SPacket
 *  net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket
 *  net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket
 *  net.minecraft.network.packet.c2s.play.ClientStatusC2SPacket
 *  net.minecraft.network.packet.c2s.play.CommandExecutionC2SPacket
 *  net.minecraft.network.packet.c2s.play.HandSwingC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerInteractBlockC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerInteractItemC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket
 *  net.minecraft.network.packet.c2s.play.RequestCommandCompletionsC2SPacket
 *  net.minecraft.network.packet.c2s.play.TeleportConfirmC2SPacket
 *  net.minecraft.network.packet.s2c.play.EntityVelocityUpdateS2CPacket
 *  net.minecraft.network.packet.s2c.play.ExplosionS2CPacket
 *  net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket
 *  net.minecraft.util.math.Vec3d
 */
package dev.idhammai.mod.modules.impl.exploit;

import com.mojang.authlib.GameProfile;
import dev.idhammai.api.events.eventbus.EventListener;
import dev.idhammai.api.events.impl.PacketEvent;
import dev.idhammai.api.events.impl.UpdateEvent;
import dev.idhammai.asm.accessors.IExplosionS2CPacket;
import dev.idhammai.mod.modules.Module;
import dev.idhammai.mod.modules.settings.impl.BindSetting;
import dev.idhammai.mod.modules.settings.impl.BooleanSetting;
import dev.idhammai.mod.modules.settings.impl.ColorSetting;
import dev.idhammai.mod.modules.settings.impl.SliderSetting;
import java.awt.Color;
import java.util.Objects;
import java.util.UUID;
import java.util.concurrent.CopyOnWriteArrayList;
import net.minecraft.client.font.TextRenderer;
import net.minecraft.client.gui.DrawContext;
import net.minecraft.client.network.OtherClientPlayerEntity;
import net.minecraft.entity.Entity;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.common.KeepAliveC2SPacket;
import net.minecraft.network.packet.c2s.play.AdvancementTabC2SPacket;
import net.minecraft.network.packet.c2s.play.ChatMessageC2SPacket;
import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket;
import net.minecraft.network.packet.c2s.play.ClientStatusC2SPacket;
import net.minecraft.network.packet.c2s.play.CommandExecutionC2SPacket;
import net.minecraft.network.packet.c2s.play.HandSwingC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerInteractBlockC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerInteractEntityC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerInteractItemC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.network.packet.c2s.play.RequestCommandCompletionsC2SPacket;
import net.minecraft.network.packet.c2s.play.TeleportConfirmC2SPacket;
import net.minecraft.network.packet.s2c.play.EntityVelocityUpdateS2CPacket;
import net.minecraft.network.packet.s2c.play.ExplosionS2CPacket;
import net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket;
import net.minecraft.util.math.Vec3d;

public class Blink
extends Module {
    public static Blink INSTANCE;
    public static OtherClientPlayerEntity fakePlayer;
    final CopyOnWriteArrayList<Packet<?>> packetsList = new CopyOnWriteArrayList();
    public final BooleanSetting render = this.add(new BooleanSetting("Render", true));
    public final BooleanSetting pauseModule = this.add(new BooleanSetting("PauseModule", true));
    public final BooleanSetting lagbackCheck = this.add(new BooleanSetting("LagbackCheck", true));
    private final BooleanSetting onlyMove = this.add(new BooleanSetting("OnlyMove", true));
    private final BooleanSetting velocity = this.add(new BooleanSetting("Velocity", false));
    private final BooleanSetting limitPackets = this.add(new BooleanSetting("LimitPackets", false));
    private final SliderSetting maxPackets = this.add(new SliderSetting("MaxPackets", 60.0, 0.0, 200.0, this.limitPackets::getValue));
    private final BooleanSetting pulse = this.add(new BooleanSetting("Pulse", false));
    private final SliderSetting factor = this.add(new SliderSetting("Factor", 1.0, 0.0, 10.0, this.pulse::getValue));
    public final BooleanSetting indicator = this.add(new BooleanSetting("Indicator", true).setParent());
    private final ColorSetting color = this.add(new ColorSetting("Color", new Color(255, 255, 255, 255), this.indicator::isOpen));
    private final SliderSetting yOffset = this.add(new SliderSetting("YOffset", 0, -200, 200, this.indicator::isOpen));
    final BindSetting cancel = this.add(new BindSetting("Cancel", -1));
    private boolean blinking;
    private Vec3d start;
    private float startYaw;
    private float startPitch;

    public Blink() {
        super("Blink", Module.Category.Exploit);
        this.setChinese("\u77ac\u79fb");
        INSTANCE = this;
    }

    @Override
    public void onRender2D(DrawContext drawContext, float tickDelta) {
        if (this.indicator.getValue()) {
            String s = "Blinking.. (" + this.packetsList.size() + ")";
            TextRenderer textRenderer = Blink.mc.textRenderer;
            int n = mc.getWindow().getScaledWidth() / 2 - Blink.mc.textRenderer.getWidth(s) / 2;
            int n2 = mc.getWindow().getScaledHeight() / 2;
            Objects.requireNonNull(Blink.mc.textRenderer);
            drawContext.drawText(textRenderer, s, n, n2 + 9 - this.yOffset.getValueInt(), this.color.getValue().getRGB(), true);
        }
    }

    @EventListener
    public void onReceivePacket(PacketEvent.Receive event) {
        EntityVelocityUpdateS2CPacket packet;
        if (Blink.nullCheck() || !this.velocity.getValue()) {
            return;
        }
        Packet<?> packet2 = event.getPacket();
        if (packet2 instanceof ExplosionS2CPacket) {
            ExplosionS2CPacket explosionS2CPacket = (ExplosionS2CPacket)packet2;
            IExplosionS2CPacket packet3 = (IExplosionS2CPacket)explosionS2CPacket;
            packet3.setVelocityX(0.0f);
            packet3.setVelocityY(0.0f);
            packet3.setVelocityZ(0.0f);
            return;
        }
        packet2 = event.getPacket();
        if (packet2 instanceof EntityVelocityUpdateS2CPacket && (packet = (EntityVelocityUpdateS2CPacket)packet2).getEntityId() == Blink.mc.player.getId()) {
            event.cancel();
        }
    }

    @Override
    public void onEnable() {
        this.packetsList.clear();
        if (Blink.nullCheck()) {
            this.disable();
            return;
        }
        this.start = Blink.mc.player.getPos();
        this.startYaw = Blink.mc.player.getYaw();
        this.startPitch = Blink.mc.player.getPitch();
        if (!this.render.getValue()) {
            return;
        }
        fakePlayer = new OtherClientPlayerEntity(Blink.mc.world, new GameProfile(UUID.fromString("11451466-6666-6666-6666-666666666601"), Blink.mc.player.getName().getString()));
        fakePlayer.copyPositionAndRotation((Entity)Blink.mc.player);
        Blink.fakePlayer.bodyYaw = Blink.mc.player.bodyYaw;
        Blink.fakePlayer.headYaw = Blink.mc.player.headYaw;
        fakePlayer.getInventory().clone(Blink.mc.player.getInventory());
        Blink.mc.world.addEntity((Entity)fakePlayer);
    }

    @EventListener
    public void onUpdate(UpdateEvent event) {
        if (Blink.mc.player.isDead()) {
            this.packetsList.clear();
            this.disable();
            return;
        }
        if (this.cancel.isPressed()) {
            this.cancel();
            return;
        }
        if (this.limitPackets.getValue() && (double)this.packetsList.size() > this.maxPackets.getValue()) {
            this.cancel();
            return;
        }
        if (this.pulse.getValue() && (double)this.packetsList.size() > this.factor.getValue() * 10.0) {
            this.blinking = true;
            for (Packet<?> packet : this.packetsList) {
                mc.getNetworkHandler().sendPacket(packet);
            }
            this.packetsList.clear();
            if (fakePlayer != null) {
                fakePlayer.copyPositionAndRotation((Entity)Blink.mc.player);
                fakePlayer.setHeadYaw(Blink.mc.player.headYaw);
                fakePlayer.setBodyYaw(Blink.mc.player.bodyYaw);
            }
            this.blinking = false;
        }
    }

    @Override
    public void onLogin() {
        if (this.isOn()) {
            this.packetsList.clear();
            this.disable();
        }
    }

    @EventListener
    public void onSendPacket(PacketEvent.Send event) {
        if (this.blinking) {
            return;
        }
        Packet<?> t = event.getPacket();
        if (t instanceof ChatMessageC2SPacket) {
            return;
        }
        if (t instanceof RequestCommandCompletionsC2SPacket) {
            return;
        }
        if (t instanceof CommandExecutionC2SPacket) {
            return;
        }
        if (t instanceof TeleportConfirmC2SPacket) {
            return;
        }
        if (t instanceof KeepAliveC2SPacket) {
            return;
        }
        if (t instanceof AdvancementTabC2SPacket) {
            return;
        }
        if (t instanceof ClientStatusC2SPacket) {
            return;
        }
        if (t instanceof ClickSlotC2SPacket) {
            return;
        }
        if (!this.onlyMove.getValue() && (event.getPacket() instanceof PlayerActionC2SPacket || event.getPacket() instanceof ClientCommandC2SPacket || event.getPacket() instanceof HandSwingC2SPacket || event.getPacket() instanceof PlayerInteractEntityC2SPacket || event.getPacket() instanceof PlayerInteractBlockC2SPacket || event.getPacket() instanceof PlayerInteractItemC2SPacket) || event.getPacket() instanceof PlayerMoveC2SPacket) {
            event.cancel();
            this.packetsList.add(event.getPacket());
        }
    }

    @EventListener
    public void onPacketEvent(PacketEvent.Receive event) {
        if (this.lagbackCheck.getValue() && event.getPacket() instanceof PlayerPositionLookS2CPacket) {
            this.cancel();
        }
    }

    private void cancel() {
        Blink.mc.player.setPosition(this.start);
        Blink.mc.player.setYaw(this.startYaw);
        Blink.mc.player.setPitch(this.startPitch);
        this.packetsList.clear();
        this.disable();
    }

    @Override
    public void onDisable() {
        if (Blink.nullCheck()) {
            this.packetsList.clear();
            this.disable();
            return;
        }
        if (fakePlayer != null) {
            fakePlayer.kill();
            fakePlayer.setRemoved(Entity.RemovalReason.KILLED);
            fakePlayer.onRemoved();
            fakePlayer = null;
        }
        for (Packet<?> packet : this.packetsList) {
            mc.getNetworkHandler().sendPacket(packet);
        }
    }

    @Override
    public String getInfo() {
        return String.valueOf(this.packetsList.size());
    }
}

