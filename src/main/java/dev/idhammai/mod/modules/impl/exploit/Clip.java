/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  net.minecraft.block.Blocks
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$Full
 *  net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket$PositionAndOnGround
 *  net.minecraft.util.math.BlockPos
 *  net.minecraft.util.math.Box
 *  net.minecraft.util.math.Direction
 *  net.minecraft.util.math.MathHelper
 *  net.minecraft.util.math.Vec3d
 */
package dev.idhammai.mod.modules.impl.exploit;

import dev.idhammai.api.events.eventbus.EventListener;
import dev.idhammai.api.events.impl.PacketEvent;
import dev.idhammai.api.events.impl.UpdateEvent;
import dev.idhammai.api.utils.math.Timer;
import dev.idhammai.api.utils.player.EntityUtil;
import dev.idhammai.api.utils.player.MovementUtil;
import dev.idhammai.api.utils.world.BlockPosX;
import dev.idhammai.mod.modules.Module;
import dev.idhammai.mod.modules.settings.impl.BooleanSetting;
import dev.idhammai.mod.modules.settings.impl.EnumSetting;
import dev.idhammai.mod.modules.settings.impl.SliderSetting;
import net.minecraft.block.Blocks;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Box;
import net.minecraft.util.math.Direction;
import net.minecraft.util.math.MathHelper;
import net.minecraft.util.math.Vec3d;

public class Clip
extends Module {
    public static Clip INSTANCE;
    private final EnumSetting<Mode> mode = this.add(new EnumSetting<Mode>("Mode", Mode.Clip));
    private final SliderSetting delay = this.add(new SliderSetting("Delay", 5, 1, 10, () -> this.mode.is(Mode.Clip)));
    private final SliderSetting rotationDelay = this.add(new SliderSetting("RotationDelay", 100, 0, 500, () -> this.mode.is(Mode.NoPacket)));
    private final BooleanSetting obsidian = this.add(new BooleanSetting("Obsidian", false, () -> this.mode.is(Mode.NoPacket)));
    private final BooleanSetting move = this.add(new BooleanSetting("Move", true, () -> this.mode.is(Mode.NoPacket)));
    private final BooleanSetting moveIn = this.add(new BooleanSetting("MoveIn", true, () -> this.mode.is(Mode.NoPacket) && this.move.isOpen()));
    private final BooleanSetting invalid = this.add(new BooleanSetting("InvalidPacket", true, () -> this.mode.is(Mode.NoPacket)));
    private final Timer timer = new Timer();
    private boolean cancel = true;
    private int packets;
    private static final double MAGIC_OFFSET = 0.20000996883537;

    public Clip() {
        super("Clip", Module.Category.Exploit);
        this.setChinese("\u5361\u5899");
        INSTANCE = this;
    }

    @Override
    public void onDisable() {
        this.packets = 0;
    }

    @Override
    public String getInfo() {
        if (this.mode.is(Mode.NoPacket)) {
            return String.valueOf(this.timer.getMs());
        }
        return String.valueOf(this.packets);
    }

    @Override
    public void onEnable() {
        if (Clip.nullCheck()) {
            return;
        }
        if (this.mode.is(Mode.NoPacket) && this.move.getValue()) {
            this.cancel = false;
            if (this.moveIn.getValue()) {
                Direction f = Clip.mc.player.getHorizontalFacing();
                Clip.mc.player.setPosition(Clip.mc.player.getX() + (double)f.getOffsetX() * 0.5, Clip.mc.player.getY(), Clip.mc.player.getZ() + (double)f.getOffsetZ() * 0.5);
                mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(Clip.mc.player.getX(), Clip.mc.player.getY(), Clip.mc.player.getZ(), true));
            } else {
                mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(Clip.mc.player.getX(), Clip.mc.player.getY(), Clip.mc.player.getZ(), true));
                Clip.mc.player.setPosition(this.roundToClosest(Clip.mc.player.getX(), Math.floor(Clip.mc.player.getX()) + 0.23, Math.floor(Clip.mc.player.getX()) + 0.77), Clip.mc.player.getY(), this.roundToClosest(Clip.mc.player.getZ(), Math.floor(Clip.mc.player.getZ()) + 0.23, Math.floor(Clip.mc.player.getZ()) + 0.77));
                mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(this.roundToClosest(Clip.mc.player.getX(), Math.floor(Clip.mc.player.getX()) + 0.23, Math.floor(Clip.mc.player.getX()) + 0.77), Clip.mc.player.getY(), this.roundToClosest(Clip.mc.player.getZ(), Math.floor(Clip.mc.player.getZ()) + 0.23, Math.floor(Clip.mc.player.getZ()) + 0.77), true));
            }
            this.cancel = true;
        }
    }

    @EventListener
    public void onUpdate(UpdateEvent event) {
        if (this.mode.is(Mode.NoPacket)) {
            if (!this.insideBlock() && this.move.getValue()) {
                this.disable();
            }
        } else if (this.mode.is(Mode.Clip)) {
            if (MovementUtil.isMoving()) {
                this.packets = 0;
                return;
            }
            if ((double)Clip.mc.player.age % this.delay.getValue() == 0.0) {
                Clip.mc.player.setPosition(Clip.mc.player.getX() + MathHelper.clamp((double)(this.roundToClosest(Clip.mc.player.getX(), Math.floor(Clip.mc.player.getX()) + 0.241, Math.floor(Clip.mc.player.getX()) + 0.759) - Clip.mc.player.getX()), (double)-0.03, (double)0.03), Clip.mc.player.getY(), Clip.mc.player.getZ() + MathHelper.clamp((double)(this.roundToClosest(Clip.mc.player.getZ(), Math.floor(Clip.mc.player.getZ()) + 0.241, Math.floor(Clip.mc.player.getZ()) + 0.759) - Clip.mc.player.getZ()), (double)-0.03, (double)0.03));
                mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(Clip.mc.player.getX(), Clip.mc.player.getY(), Clip.mc.player.getZ(), true));
                mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.PositionAndOnGround(this.roundToClosest(Clip.mc.player.getX(), Math.floor(Clip.mc.player.getX()) + 0.23, Math.floor(Clip.mc.player.getX()) + 0.77), Clip.mc.player.getY(), this.roundToClosest(Clip.mc.player.getZ(), Math.floor(Clip.mc.player.getZ()) + 0.23, Math.floor(Clip.mc.player.getZ()) + 0.77), true));
                ++this.packets;
            }
        } else if (this.mode.is(Mode.HitboxDesync)) {
            Direction f = Clip.mc.player.getHorizontalFacing();
            Box bb = Clip.mc.player.getBoundingBox();
            Vec3d center = bb.getCenter();
            Vec3d offset = new Vec3d(f.getUnitVector());
            Vec3d fin = this.merge(new BlockPosX(center).toCenterPos().add(0.0, -0.5, 0.0).add(offset.multiply(0.20000996883537)), f);
            Clip.mc.player.setPosition(fin.x == 0.0 ? Clip.mc.player.getX() : fin.x, Clip.mc.player.getY(), fin.z == 0.0 ? Clip.mc.player.getZ() : fin.z);
            this.disable();
        }
    }

    private Vec3d merge(Vec3d keyCodec, Direction facing) {
        return new Vec3d(keyCodec.x * (double)Math.abs(facing.getOffsetX()), keyCodec.y * (double)Math.abs(facing.getOffsetY()), keyCodec.z * (double)Math.abs(facing.getOffsetZ()));
    }

    @EventListener
    public void onPacket(PacketEvent.Send event) {
        Packet<?> packet;
        if (Clip.nullCheck() || !this.mode.is(Mode.NoPacket)) {
            return;
        }
        if (this.cancel && (packet = event.getPacket()) instanceof PlayerMoveC2SPacket) {
            PlayerMoveC2SPacket packet2 = (PlayerMoveC2SPacket)packet;
            if (!this.insideBlock()) {
                if (this.move.getValue()) {
                    this.disable();
                }
                return;
            }
            if (packet2.changesLook() && this.timer.passedMs(this.rotationDelay.getValue())) {
                float packetYaw = packet2.getYaw(0.0f);
                float packetPitch = packet2.getPitch(0.0f);
                this.cancel = false;
                if (this.invalid.getValue()) {
                    mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.Full(Clip.mc.player.getX(), Clip.mc.player.getY() + 1337.0, Clip.mc.player.getZ(), packetYaw, packetPitch, false));
                    mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.Full(Clip.mc.player.getX(), Clip.mc.player.getY() - 1337.0, Clip.mc.player.getZ(), packetYaw, packetPitch, false));
                } else {
                    mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.Full(Clip.mc.player.getX(), Clip.mc.player.getY() + 2.0, Clip.mc.player.getZ(), packetYaw, packetPitch, false));
                    mc.getNetworkHandler().sendPacket((Packet)new PlayerMoveC2SPacket.Full(Clip.mc.player.getX(), Clip.mc.player.getY() - 2.0, Clip.mc.player.getZ(), packetYaw, packetPitch, false));
                }
                this.cancel = true;
                this.timer.reset();
            }
            event.cancel();
        }
    }

    public boolean insideBlock() {
        BlockPos playerBlockPos = EntityUtil.getPlayerPos(true);
        for (int xOffset = -1; xOffset <= 1; ++xOffset) {
            for (int yOffset = -1; yOffset <= 1; ++yOffset) {
                for (int zOffset = -1; zOffset <= 1; ++zOffset) {
                    BlockPos offsetPos = playerBlockPos.add(xOffset, yOffset, zOffset);
                    if (Clip.mc.world.getBlockState(offsetPos).getBlock() != Blocks.BEDROCK && (Clip.mc.world.getBlockState(offsetPos).getBlock() != Blocks.OBSIDIAN || !this.obsidian.getValue()) || !Clip.mc.player.getBoundingBox().intersects(new Box(offsetPos))) continue;
                    return true;
                }
            }
        }
        return false;
    }

    private double roundToClosest(double num, double low, double high) {
        double d2 = high - num;
        double d1 = num - low;
        if (d2 > d1) {
            return low;
        }
        return high;
    }

    public static enum Mode {
        HitboxDesync,
        Clip,
        NoPacket;

    }
}

